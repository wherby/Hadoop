"use strict";define("bundles/programming/components/GradeHistory",["require","exports","module","classnames","react-with-addons","underscore","bundles/phoenix/components/Time","bundles/phoenix/lib/multitrackerMixin","bundles/programming/models/submissionHistory","bundles/programming/promises/gradingStatuses","bundles/teach-course/components/TooltipTools","i18n!nls/programming","pages/open-course/assessment/models/exam/evaluation","css!bundles/programming/components/__styles__/GradeHistory.css"],function(require,exports,module){var a=require("classnames"),e=require("react-with-addons"),_=require("underscore"),c=require("bundles/phoenix/components/Time"),i=require("bundles/phoenix/lib/multitrackerMixin"),l=require("bundles/programming/models/submissionHistory"),d=require("bundles/programming/promises/gradingStatuses"),n=require("bundles/teach-course/components/TooltipTools"),s=require("i18n!nls/programming"),r=require("pages/open-course/assessment/models/exam/evaluation");require("css!bundles/programming/components/__styles__/GradeHistory.css");var u=n.Tooltip,f=n.TooltipTargetMixin,t=function getMetadata(e){return function(){return this.props.itemMetadata.get(e)}},m=e.createClass({displayName:"GradingFailedLabel",mixins:[f],render:function render(){return e.createElement("span",{className:"bt3-text bt3-text-danger rc-GradingFailedLabel",onMouseOver:this.tooltipTargetMouseOver,onMouseOut:this.tooltipTargetMouseOut},s("Grading failed")," ","  ",e.createElement("i",{className:"cif-question-circle"}),this.state.showTooltip&&e.createElement(u,{direction:"north"},s("Please try again after some time while we look at resolving this issue!")))}}),p=[{title:s("Date"),classes:"col col-datetime flex-1",value:function value(t,s){var i=a("submission-expander",{"cif-chevron-down":s.state.isExpanded,"cif-chevron-right":!s.state.isExpanded}),n="successed"===t.get("gradingStatus");return e.createElement("span",null,(n||s.props.showDebugTools)&&e.createElement("i",{className:i}),e.createElement(c,{time:t.get("submittedAt")}))}},{title:s("Score"),classes:"col col-score align-right",value:function value(s,t){if("successed"===s.get("gradingStatus"))return e.createElement("span",null,e.createElement("span",null,s.get("score")+"/"+s.get("maxScore")))}},{title:s("Passed?"),classes:"col col-passed align-horizontal-center",value:function value(t,i){switch(t.get("gradingStatus")){case"failed":return e.createElement(m,{tooltipTimeDelay:"0"});case"successed":var a=new r(t.pick("score","maxScore","passingFraction"));return s(a.isPassed()?"Yes":"No")}}}],g=e.createClass({displayName:"PartActions",render:function render(){return this.props.part.get("isSubmitted")?e.createElement("div",{className:"rc-PartActions"},e.createElement("a",{href:"#",onClick:this.props.onToggle},s(this.props.isExpanded?"Hide":"Show")," ",s("grader output"))):null}}),h=[{classes:"col col-name flex-1",value:function value(a,i){var s=i.props,n=s.showDebugTools,t=s.status;return e.createElement("div",null,e.createElement("div",null,a.get("title")),n&&t&&e.createElement("div",{className:"caption"},"Executor Run ID: ",t.executorRunId))}},{classes:"col col-score align-right",value:function value(a,i){var s=new r(a.pick("score","maxScore","passingFraction")),t=s.get("score");return e.createElement("span",null,"number"!=typeof t?e.createElement("span",null,"â€”"):t,"/",s.get("maxScore"))}},{classes:"col col-actions align-horizontal-center",value:function value(t,s){return e.createElement(g,{part:t,isExpanded:s.state.isExpanded,onToggle:s.toggle})}}],b=e.createClass({displayName:"GraderOutput",render:function render(){var t=this.props.output;return void 0===t?e.createElement("div",null,s("Loading...")):e.createElement("div",{className:"rc-GraderOutput"},t)}}),E=e.createClass({displayName:"SubmissionPartRow",mixins:[i],multitracker:{namespace:"open_course_item.programing_grid_submissions",baseValues:["open_course_id","module_id","lesson_id","item_id"],definitions:{open_course_id:t("course.id"),module_id:t("lesson.module.id"),lesson_id:t("lesson.id"),item_id:t("id")},events:{toggle_grader_output:[]}},getInitialState:function getInitialState(){return{isExpanded:!1,output:void 0}},toggle:function toggle(s){s.preventDefault();var t=this.props.submission,a=this.state.isExpanded,e=!a;this.track("toggle_grader_output",{is_expanded:e}),this.setState({isExpanded:e}),e&&t.loadFeedbacks(this.props.itemMetadata).then(this.onGraderOutputSuccess,this.onGraderOutputError).done()},onGraderOutputSuccess:function onGraderOutputSuccess(e){this.setState({output:this.props.part.get("feedback")||null})},onGraderOutputError:function onGraderOutputError(e){this.setState({output:s("There was an error loading feedback. Please refresh the page and try again later.")})},render:function render(){var s=this,t=this.props.part,a=h.slice();return e.createElement("div",{className:"rc-SubmissionPartRow"},e.createElement("div",{className:"cols"},a.map(function(a,i){return e.createElement("div",{key:i,className:a.classes},a.value(t,s))})),this.state.isExpanded&&e.createElement(b,{output:this.state.output}))}}),v=e.createClass({displayName:"SubmissionRow",mixins:[i],multitracker:{namespace:"open_course_item.programing_grid_submissions",baseValues:["open_course_id","module_id","lesson_id","item_id"],definitions:{open_course_id:t("course.id"),module_id:t("lesson.module.id"),lesson_id:t("lesson.id"),item_id:t("id")},events:{toggle_submission:[]}},getInitialState:function getInitialState(){return{isExpanded:!1,isLoadingStatuses:!1,areStatusesLoaded:!1,gradingStatuses:null}},componentDidMount:function componentDidMount(){this.props.startsExpanded&&this.toggle()},toggle:function toggle(a){a&&a.preventDefault();var s=this.props,c=s.itemMetadata,i=s.submission,n=s.showDebugTools,e=this.state,o=e.isExpanded,l=e.isLoadingStatuses,u=e.areStatusesLoaded,t=!o;if(n&&t&&!u&&!l){this.setState({isLoadingStatuses:!0});var r=d({itemMetadata:c,submissionId:i.get("id")});r.then(this.onGradingStatusesSuccess,this.onGradingStatusesError)}this.track("toggle_submission",{is_expanded:t}),this.setState({isExpanded:t})},onGradingStatusesSuccess:function onGradingStatusesSuccess(e){this.setState({isLoadingStatuses:!1,areStatusesLoaded:!0,gradingStatuses:e})},onGradingStatusesError:function onGradingStatusesError(e){console.error("Unable to load grading statuses",e),this.setState({isLoadingStatuses:!1})},render:function render(){var n=this,t=this.props,m=t.cols,i=t.submission,s=t.showDebugTools,o=this.state,l=o.gradingStatuses,d=o.isLoadingStatuses,r=i.get("gradingStatus"),u="successed"===r,p=a("rc-SubmissionRow",{"in-progress":"started"===r,failed:"failed"===r&&!s}),c=i.get("partEvaluations").toArray().sort(function(e,s){return e.get("order")-s.get("order")});return e.createElement("div",{className:p},e.createElement("div",{className:"inner"},e.createElement("div",{className:"cols",onClick:(u||s)&&this.toggle},m.map(function(s){return e.createElement("div",{key:s.title,className:s.classes},s.value(i,n))})),(u||s)&&this.state.isExpanded&&e.createElement("div",{className:"parts"},c.map(function(t){return e.createElement(E,{key:t.get("order"),itemMetadata:n.props.itemMetadata,submission:n.props.submission,part:t,showDebugTools:s,isLoadingStatuses:d,status:l&&l.getPartForId(t.get("partId"))})}))))}}),o=e.createClass({displayName:"GradeHistory",propTyps:{itemMetadata:e.PropTypes.object.isRequired,submissions:e.PropTypes.instanceOf(l).isRequired,showDebugTools:e.PropTypes.bool},render:function render(){var t=this.props,n=t.itemMetadata,a=t.submissions,r=t.showDebugTools,i=p.slice();return a?e.createElement("div",{className:"rc-GradeHistory"},e.createElement("div",{className:"submissions"},e.createElement("div",{className:"headers"},i.map(function(s){return e.createElement("div",{key:s.title,className:"header "+s.classes},s.title)})),a.map(function(s,t){return e.createElement(v,{key:s.get("id"),itemMetadata:n,submission:s,cols:i,startsExpanded:0===t,showDebugTools:r})}))):e.createElement("div",null,s("Loading"),"...")}});module.exports=o});